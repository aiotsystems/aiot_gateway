<!DOCTYPE html>
<html>
<head>
    <title>Inria Museum</title>
    <link rel="stylesheet" type="text/css" href="InriaMuseum.css"> 
    <script>


        var current_page; //global variable
        var previous_page;
        function handleButtonClick(event) { //event listener for buttons
            console.log(`ct handleButtonClick ${event}`);
            console.log(`event.target.id ${event.target.id}`);

            if(event.target.id == ""){
                const parentElementId = event.target.parentElement ?
                event.target.parentElement.id : 'No parent element';
                console.log(`event.target.id ${event.target.parentElement.id}`)
                changePage(parentElementId);
            }else{
                changePage(event.target.id);
            }
        }
        
        function changePage(ElementId) {
            console.log(`fct changePage ${ElementId}`);
            switch (ElementId) {
                case "button_start_fr":
                    current_page='launching.svg';
                    break;
                case "button_active": 
                    current_page='map.svg';
                    break;
                case "button_suite":
                    current_page='select_music.svg'
                    break;
                case "button_music1" :
                    music_1();
                    break;

                case "button_music2" :
                    music_2();
                    break;
                case "button1":
                    current_page='map.svg';
                    change_map();
                    break;
                case "button2":
                    current_page='map.svg';
                    break;
                case "button3":
                    current_page='map.svg';
                    break;
                case "button4":
                    current_page='map.svg';
                    break;
                    
                case "button_copyright":
                    previous_page = current_page;
                    current_page='credits.svg';
                    break;
                case "button_leave":
                    current_page = previous_page;
                    break;
                default :
                    console.log(`default ${ElementId} `); 
                    break;
            }
            if (ElementId == "button1" ||ElementId == "button2"||ElementId == "button3"|| ElementId == "button4" ){
                    ; // do nothing
            }
            else{        
                loadSVG(current_page);
                checkPage();
            }
        }

        function change_map(){
                console.log("loaded");
                let page = "map.svg";
                loadSVG(page);
                // Select the existing circle element by its ID
                const existingCircle = document.getElementById("big_data_mote");
                console.log(existingCircle);
                // Create a new <g> element
                const newGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                newGroup.setAttribute("id", "active_big_data_mote");

                // Define the new circles
                const circlesData = [
                    { class: "cls-5", cx: 581.78, cy: 934.53, r: 12.19 },
                    { class: "cls-3", cx: 581.78, cy: 934.53, r: 20.08 },
                    { class: "cls-2", cx: 581.78, cy: 934.53, r: 25.08 },
                    { class: "cls-4", cx: 581.78, cy: 934.53, r: 30.95 },
                ];

                // Create the circles and append them to the group
                circlesData.forEach(circleData => {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("class", circleData.class);
                    circle.setAttribute("cx", circleData.cx);
                    circle.setAttribute("cy", circleData.cy);
                    circle.setAttribute("r", circleData.r);
                    newGroup.appendChild(circle);
                });

                // Replace the existing circle with the new group
                if (existingCircle && existingCircle.parentNode) {
                    existingCircle.parentNode.replaceChild(newGroup, existingCircle);
                    console.log("element replaced");
                }




        }


        function music_1(){
            console.log("music1");
            current_page = "num_people.svg";
        }
        function music_2(){
            console.log("music2");
            current_page = "num_people.svg";
        }
        function checkPage() {
            console.log("fct checkPage");
            // display defi page(introduction.svg) after 3s
            if(current_page=="launching.svg"){
                current_page = "introduction.svg";
                setTimeout(function(){
                     loadSVG(current_page);
                     }, 3000);
            }


            if(current_page=="activate_mote.svg"){
                getData();
                /*
                //switch to other page
                current_page = "listening.svg";
                console.log(`time${current_page} `);
                setTimeout(function(){
                    loadSVG(current_page);
                }, 5000);*/
            }
        }

        function loadSVG(filename) {
            console.log("fct loadSVG");
            const filePath = `svg/${filename}`;
            console.log(`New page ${filename} `);
            fetch(filePath)
                .then(response => response.text())
                .then(svgContent => {
                    document.getElementById('svgContainer').innerHTML = svgContent;
                    loadelement();
                })
                .catch(error => console.error('Error loading SVG:', error));
        }
        
        function loadelement() { // Initialize buttons & add listeners
            console.log("fct load element");
            const ids = ["button_start_fr", "button_start_fr_label", "button_copyright", "button_active",
                        "button_suite_group", "button_leave", "button_music1", "button_music2",
                        "button_défis", "button_défis-2", "button1", "button2", "button3", "button4"];
            

            // Set inactivity timeout (5 minutes in milliseconds)
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000;
            // Function to redirect to welcome page
            // after 5 minutes of no clicks
            function redirectToWelcome() {
                let redirect_page = "welcome.svg"
                loadSVG(redirect_page);
            }
            // Reset the inactivity timer function
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(redirectToWelcome, INACTIVITY_TIMEOUT); // 5-minute timeout
            }        
            let inactivityTimer = setTimeout(redirectToWelcome, INACTIVITY_TIMEOUT); // Initial timer
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("click", (event) => {
                        handleButtonClick(event);
                        resetInactivityTimer(); // Reset timer on each click
                    });
                    console.log(`Event listener attached to: ${id}`);
                } else {
                    console.log(`Element with id ${id} not found`);
                }
            });
        }


        function changeColor(color,id){ //changin the color of element
            console.log(`Change color of : ${id} to ${color}`)
            const element = document.getElementById(id);
            if (element) {
                element.style.fill = color;
            } else {
                console.error(`Element with ID :${id} not found`);
            }
        }

        //get data from mote
        // change color of elemnt with (position + board) id
        function getData(){ 
            console.log("fct loaddata");
            fetch('/api/message')
            .then(response => response.json())
            .then(data => {
                console.log(`Message catch: ${data.message["position"]}`);
                temp = data.message["position"] + "_board"
                if(data.message["isSomeone"]==true){                    
                    changeColor("orange",temp);
                }else{
                    changeColor("black",temp);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

        }



        window.onload = function() { //interface init
            loadSVG('welcome.svg');
        }






    </script>
</head>


<body>
    <section id="svgContainer" class="doc">
    </section>
</body>
</html>
